=== KosTeams payments for Яндекс Пей & Яндекс Сплит for WooCommerce ===
Contributors: pro100kostia
Tags: yandex pay, payments, yandex split, яндекс сплит, сплит
Requires at least: 6.0
Tested up to: 6.8
Requires PHP: 8.0.0
Stable tag: 1.0.13
License: GPLv2 or later
License URI: https://www.gnu.org/licenses/gpl-2.0.html

Принимайте оплату через Yandex Pay, Яндекс Сплит или их комбинацию. Увеличьте конверсию за счет гибких способов оплаты с плагином от KosTeams.

== Описание ==
Плагин добавляет в ваш магазин на WooCommerce популярные способы оплаты от Яндекса:
- **Yandex Pay**: мгновенная оплата картой без ввода данных.
- **Яндекс Сплит**: рассрочка без переплат до 6 месяцев.
- **Комбинированная оплата**: часть суммы картой, остаток — в рассрочку.

Для расширенных возможностей (бейджи рассрочки, виджеты в корзине и каталоге) доступна [Pro-версия плагина](https://kosteams.com/).

== Важная информация о фискализации ==

**Обратите внимание:** При использовании Яндекс Pay и Яндекс Сплит необходимо соблюдать требования российского законодательства по фискализации платежей.

= Требования 54-ФЗ =
Согласно Федеральному закону "О применении контрольно-кассовой техники" (54-ФЗ):
- При любых формах безналичных расчетов необходимо выдавать фискальные чеки
- Яндекс Pay и Яндекс Сплит не отправляют фискальные чеки автоматически
- Ответственность за соблюдение требований фискализации лежит на продавце

= Возможные решения =
Для обеспечения соответствия 54-ФЗ рассмотрите следующие варианты:
- Интеграция с онлайн-кассами (АТОЛ, Эвотор, ОФД и др.)
- Использование специализированных плагинов для автоматической отправки чеков
- Настройка API интеграции с вашим поставщиком фискальных услуг
- Консультация с сертифицированными интеграторами ККТ

= Штрафы за нарушение =
- Для индивидуальных предпринимателей: от 10 000 рублей за каждый случай
- Для юридических лиц: от 30 000 рублей за каждое нарушение
- Возможна приостановка деятельности на срок до 90 суток

**Рекомендация:** Обязательно настройте фискализацию до начала приема платежей через Яндекс Pay. За подробной консультацией обратитесь к вашему бухгалтеру или поставщику услуг онлайн-касс.

== Установка ==
1. Установите плагин через административную панель WordPress.
2. Активируйте его в разделе «Плагины».
3. Перейдите в WooCommerce → Настройки → Платежи → Яндекс Пей & Яндекс Сплит.
4. Введите Merchant ID и API-ключ (получаются через партнерский договор с Яндексом).
5. Включите нужные методы оплаты и сохраните изменения.
6. **Важно:** Настройте фискализацию платежей в соответствии с 54-ФЗ.

== Часто задаваемые вопросы ==

= Почему не проходит оплата? =
Проверьте, прошел ли магазин модерацию в личном кабинете Яндекс Pay (должен отображаться зеленый статус). Если статус серый, оплата будет работать только в тестовом режиме.

= Нужен ли договор с Яндексом? =
Да, для работы плагина требуется подключение к Яндекс Пэй через партнерский договор.

= Почему не отображается виджет в Gutenberg? =
На данный момент работает классический шорткод. Gutenberg планируется в следующих обновлениях.

= Как работает Сплит для покупателя? =
Покупатель оформляет заказ, вносит первый платёж и получает товар сразу. Остальные платежи списываются по расписанию. Магазин получает всю сумму сразу, как при обычной покупке.

= Как добавить бейджи рассрочки в карточке товара? =
Эта функция доступна в Pro-версии, которая позволяет настраивать дизайн, позиционирование и условия отображения элементов.

= Почему виджеты не отображаются в корзине? =
Интеграция с корзиной и оформлением заказа поддерживается в Pro-версии. Бесплатная версия фокусируется на базовой реализации платежей.

= Как проверить работу в тестовом режиме? =
Используйте тестовые данные от Яндекса. Реальные деньги не будут списаны.

= Как обеспечить фискализацию платежей? =
Яндекс Pay не отправляет фискальные чеки автоматически. Рекомендуемые решения:

**Готовое решение (рекомендуется):**
- [KosTeams АТОЛ Чеки v4](https://kosteams.com/atol-receipts-yandex-v4/) - специализированный плагин, который автоматически отправляет чеки для всех платежей через Яндекс Pay и Сплит

**Альтернативные варианты:**
- Подключить онлайн-кассу (АТОЛ, Эвотор и др.) и настроить API интеграцию
- Использовать другие плагины для фискализации
- Разработать собственную интеграцию с ОФД
- Проконсультироваться с вашим поставщиком ККТ услуг

= Какие штрафы за отсутствие фискализации? =
Согласно 54-ФЗ, за неприменение ККТ предусмотрены штрафы от 10 000 рублей для ИП и от 30 000 рублей для ООО за каждый случай нарушения.

== Возможности версий ==
**Бесплатная версия включает:**
- Поддержка Yandex Pay и Яндекс Сплит
- Комбинированная оплата (карта + рассрочка)
- Настройка через интерфейс WooCommerce
- Совместимость с классическим редактором

**Pro-версия добавляет:**
- Бейджи рассрочки/кэшбэка в карточках товаров
- Бейджи рассрочки/кэшбэка в каталоге товара
- Виджеты оплаты в корзине и каталоге
- 20+ вариантов позиционирования элементов

== Рекомендуемые дополнения ==

Для обеспечения полного соответствия требованиям российского законодательства и расширения функциональности рекомендуются следующие решения:

= Фискализация платежей (обязательно для соблюдения 54-ФЗ) =

**[KosTeams АТОЛ Чеки v4](https://kosteams.com/atol-receipts-yandex-v4/)** - Специализированный плагин для автоматической фискализации платежей через Яндекс Pay и Яндекс Сплит.

Основные возможности:
- Автоматическая отправка фискальных чеков в АТОЛ Онлайн при каждом платеже
- Полная поддержка АТОЛ API v4 и ФФД 1.05
- Автоматическое определение платежей через Яндекс Pay/Сплит
- Поддержка HPOS (High-Performance Order Storage)
- Автоматические чеки возврата при отмене заказов
- Мониторинг статусов фискализации в реальном времени
- Детальное логирование для диагностики проблем

**Почему именно этот плагин:**
- Разработан специально для интеграции с Яндекс платежными системами
- Автоматически определяет платежи, которые требуют фискализации
- Полностью соответствует требованиям 54-ФЗ
- Тестируется совместно с данным плагином

= Альтернативные решения фискализации =
- Другие плагины интеграции с АТОЛ Онлайн
- Решения для интеграции с Эвотор
- Модули подключения к другим ОФД
- API интеграции с вашим поставщиком ККТ

= Улучшение конверсии =
**[KosTeams Яндекс Pay PRO](https://kosteams.com/)** - Расширенная версия текущего плагина с дополнительными возможностями:
- Бейджи рассрочки/кэшбэка в карточках и каталоге товаров
- Виджеты оплаты в корзине и на страницах товаров
- 20+ вариантов позиционирования элементов
- Расширенные настройки дизайна и поведения

**Важно:** Независимо от выбранного решения для фискализации, его настройка обязательна до начала приема платежей через Яндекс Pay для соблюдения требований 54-ФЗ.

== Ссылки ==
- [Документация по настройке](https://kosteams.com/)
- [Купить Pro-версию](https://kosteams.com/)
- [Информация о 54-ФЗ и фискализации](https://www.consultant.ru/document/cons_doc_LAW_42359/12a6477d0e22968564d9416e594a80202a7024db/)

== Changelog ==

= 1.0.13 =
* Дата: 2025-08-23
* Мелкие доработки

= 1.0.12 =
* Дата: 2025-08-03
* **КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ**: Устранена ошибка ORDER_AMOUNT_MISMATCH при создании платежей
* Исправлено: Точность расчета сумм с учетом скидок и округлений
* Исправлено: Погрешности в распределении скидок по товарам
* Улучшено: Алгоритм коррекции итоговых сумм для соответствия требованиям API Яндекса
* Улучшено: Точность математических операций с денежными суммами
* Добавлено: Автоматическая коррекция погрешностей округления в последнем товаре корзины
* Добавлено: Дополнительное логирование для отладки расчетов сумм
* **Техническое**: Соответствие WordPress Coding Standards для интернационализации
* **Техническое**: Добавлены комментарии переводчика для всех локализуемых строк
* **Техническое**: Упорядочены плейсхолдеры в переводимых строках (%1$s, %2$s)

= Детали исправления ошибки ORDER_AMOUNT_MISMATCH =
Ошибка возникала из-за несоответствия формулы: `cart_total = items_sum - discounts_sum`
* Добавлено точное округление на всех этапах расчетов (round с 2 знаками)
* Реализована проверка соответствия calculated_total с woocommerce_total
* При расхождении ≥0.01 выполняется автоматическая коррекция последнего товара
* Улучшено распределение остатков скидок между товарами
* Добавлена финальная валидация всех сумм перед отправкой в API

= Техническое описание =
* Все денежные операции теперь выполняются с `round($value, 2)`
* Добавлена проверка `abs($calculated_total - $woocommerce_total) >= 0.01`
* Реализована коррекция через adjustment последнего товара в корзине
* Улучшено логирование с выводом всех промежуточных сумм для отладки
* Приведение к стандартам WordPress для корректной локализации

= 1.0.11 =
* Дата: 2025-07-20
* Добавлено: Защита от изменения статуса заказов, оплаченных другими платежными системами
* Добавлено: Интеллектуальная обработка вебхуков с учетом способа оплаты
* Улучшено: Логика обработки статусов заказов для предотвращения конфликтов между платежными системами
* Улучшено: Обработка легитимных операций отмены/возврата для заказов Яндекс
* Исправлено: Проблема с отменой оплаченных заказов при получении вебхука от Яндекс после оплаты другим способом

= Защита заказов =
* Если заказ был оплачен через другую платежную систему, вебхуки от Яндекс больше не будут менять его статус
* Заказы, оплаченные через Яндекс, корректно обрабатывают операции отмены и возврата из личного кабинета Яндекс
* Добавлены информативные заметки к заказам при попытках изменения статуса

= Техническое описание =
* Метод `process_order_status_from_webhook` теперь проверяет способ оплаты заказа перед применением изменений
* Добавлена проверка `$is_yandex_payment` для определения источника оплаты
* Улучшено логирование для отслеживания всех попыток изменения статусов

= 1.0.10 =
* Дата: 2025-06-17
* Добавлено: Расширенная обработка вебхуков Яндекс Пэй
* Добавлено: Гибкая система маппинга статусов платежей
* Добавлено: Кастомные фильтры для разработчиков
* Улучшено: Рефакторинг обработки вебхуков для повышения надежности
* Улучшено: Логирование операций с платежами
* Улучшено: Безопасность обработки входящих запросов

= Фильтры для разработчиков =

1. `yandex_pay_webhook_status_map`
Изменяет соответствие статусов Яндекс → WooCommerce
Параметры:
- $status_map (array) - Текущий маппинг статусов
- $order (WC_Order) - Объект заказа
- $payment_status (string) - Статус от Яндекс

Пример:
add_filter('yandex_pay_webhook_status_map', function($status_map, $order, $payment_status) {
    $status_map['CAPTURED'] = 'completed';
    return $status_map;
}, 10, 3);

2. `yandex_pay_before_process_status`
Изменяет статус перед применением к заказу
Параметры:
- $new_status (string) - Планируемый статус
- $payment_status (string) - Статус от Яндекс
- $order (WC_Order) - Объект заказа

3. `yandex_pay_handle_webhook_status`
Полная кастомная обработка статуса (возврат true отменяет стандартную обработку)
Параметры:
- $handled (bool) - Флаг обработки
- $payment_status (string) - Статус от Яндекс
- $order (WC_Order) - Объект заказа

4. `yandex_pay_status_change_note`
Изменяет заметку при смене статуса заказа
Параметры:
- $note (string) - Текст заметки
- $order (WC_Order) - Объект заказа
- $old_status (string) - Старый статус
- $new_status (string) - Новый статус

5. `yandex_pay_partial_refund_note`
Изменяет заметку для частичного возврата
Параметры:
- $note (string) - Текст заметки
- $order (WC_Order) - Объект заказа

= Улучшения безопасности =
* Усилена валидация входящих данных
* Улучшена обработка ошибок декодирования

= Исправлено =
* Проблемы с обработкой статуса PARTIALLY_REFUNDED

= 1.0.9 =
- В платежном шлюзе Яндекс Сплит реализована динамическая смена иконки в зависимости от выбранного способа оплаты
- При выборе "Сплит" отображается стандартная иконка Сплита
- При выборе "Карта + Сплит" отображается комбинированная иконка

= 1.0.8 =
= Улучшено распределение скидок =
- Все типы скидок (купоны, бонусы, отрицательные сборы) суммируются в общую сумму скидки
- Скидки распределяются пропорционально по товарам
- Остаток скидки добавляется к последнему товару для точного распределения
= Улучшено формирование корзины =
- Для товаров с количеством > 1 создаются отдельные позиции
- Скидка равномерно распределяется между единицами товара
- Скидки применяются только к товарам (не к доставке и сборам)

= 1.0.7 =
- Реализовано разделение стилей
- Мелки исправления
- Улучшена документация

= 1.0.6 =
**Основные изменения:**  
- Добавлены отдельные платежные шлюзы:  
  • `Яндекс Сплит` — оплата частями  
  • `Яндекс Пей` — классическая оплата картой  
- Реализовано разделение общей логики в базовый класс (`WC_Yandex_Base_Gateway`)  
- Улучшено хранение ссылок платежей:  
  • Платежные URL сохраняются в метаданные заказа  
  • Исключено повторное создание платежей для существующих заказов  

= 1.0.5 =
- Исправлена совместимость с WooCommerce 8.7
- Обновлены тестовые сценарии для PHP 8.3

= 1.0.4 =
- Добавлена поддержка мультиязычных сайтов
- Оптимизирована загрузка скриптов

= 1.0 =
- Первый релиз
- Базовая интеграция Yandex Pay/Сплит
- Поддержка классического редактора

== Лицензия ==
Этот плагин распространяется под лицензией GPLv2. Расширенные функции доступны в Pro-версии.

== Поддержка и безопасность ==

= Безопасность платежей =
- Все транзакции обрабатываются через защищенные серверы Яндекса
- Данные карт не сохраняются на вашем сайте
- Соответствие стандартам PCI DSS

= Соответствие законодательству =
- Плагин обеспечивает техническую интеграцию с платежными системами
- Соблюдение требований фискализации (54-ФЗ) требует дополнительных решений
- Рекомендуется консультация с юристами и бухгалтерами

= Получение поддержки =
- Техническая поддержка через официальные каналы
- Документация и FAQ на сайте разработчика
- Сообщество пользователей для обмена опытом

= 1.0.12 =
* Дата: 2025-08-03
* **КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ**: Устранена ошибка ORDER_AMOUNT_MISMATCH при создании платежей
* Исправлено: Точность расчета сумм с учетом скидок и округлений
* Исправлено: Погрешности в распределении скидок по товарам
* Улучшено: Алгоритм коррекции итоговых сумм для соответствия требованиям API Яндекса
* Улучшено: Точность математических операций с денежными суммами
* Добавлено: Автоматическая коррекция погрешностей округления в последнем товаре корзины
* Добавлено: Дополнительное логирование для отладки расчетов сумм
* **Техническое**: Соответствие WordPress Coding Standards для интернационализации
* **Техническое**: Добавлены комментарии переводчика для всех локализуемых строк
* **Техническое**: Упорядочены плейсхолдеры в переводимых строках (%1$s, %2$s)

= Детали исправления ошибки ORDER_AMOUNT_MISMATCH =
Ошибка возникала из-за несоответствия формулы: `cart_total = items_sum - discounts_sum`
* Добавлено точное округление на всех этапах расчетов (round с 2 знаками)
* Реализована проверка соответствия calculated_total с woocommerce_total
* При расхождении ≥0.01 выполняется автоматическая коррекция последнего товара
* Улучшено распределение остатков скидок между товарами
* Добавлена финальная валидация всех сумм перед отправкой в API

= Техническое описание =
* Все денежные операции теперь выполняются с `round($value, 2)`
* Добавлена проверка `abs($calculated_total - $woocommerce_total) >= 0.01`
* Реализована коррекция через adjustment последнего товара в корзине
* Улучшено логирование с выводом всех промежуточных сумм для отладки
* Приведение к стандартам WordPress для корректной локализации

= 1.0.11 =
* Дата: 2025-07-20
* Добавлено: Защита от изменения статуса заказов, оплаченных другими платежными системами
* Добавлено: Интеллектуальная обработка вебхуков с учетом способа оплаты
* Улучшено: Логика обработки статусов заказов для предотвращения конфликтов между платежными системами
* Улучшено: Обработка легитимных операций отмены/возврата для заказов Яндекс
* Исправлено: Проблема с отменой оплаченных заказов при получении вебхука от Яндекс после оплаты другим способом

= Защита заказов =
* Если заказ был оплачен через другую платежную систему, вебхуки от Яндекс больше не будут менять его статус
* Заказы, оплаченные через Яндекс, корректно обрабатывают операции отмены и возврата из личного кабинета Яндекс
* Добавлены информативные заметки к заказам при попытках изменения статуса

= Техническое описание =
* Метод `process_order_status_from_webhook` теперь проверяет способ оплаты заказа перед применением изменений
* Добавлена проверка `$is_yandex_payment` для определения источника оплаты
* Улучшено логирование для отслеживания всех попыток изменения статусов

= 1.0.10 =
* Дата: 2025-06-17
* Добавлено: Расширенная обработка вебхуков Яндекс Пэй
* Добавлено: Гибкая система маппинга статусов платежей
* Добавлено: Кастомные фильтры для разработчиков
* Улучшено: Рефакторинг обработки вебхуков для повышения надежности
* Улучшено: Логирование операций с платежами
* Улучшено: Безопасность обработки входящих запросов

= Фильтры для разработчиков =

1. `yandex_pay_webhook_status_map`
Изменяет соответствие статусов Яндекс → WooCommerce
Параметры:
- $status_map (array) - Текущий маппинг статусов
- $order (WC_Order) - Объект заказа
- $payment_status (string) - Статус от Яндекс

Пример:
add_filter('yandex_pay_webhook_status_map', function($status_map, $order, $payment_status) {
    $status_map['CAPTURED'] = 'completed';
    return $status_map;
}, 10, 3);

2. `yandex_pay_before_process_status`
Изменяет статус перед применением к заказу
Параметры:
- $new_status (string) - Планируемый статус
- $payment_status (string) - Статус от Яндекс
- $order (WC_Order) - Объект заказа

3. `yandex_pay_handle_webhook_status`
Полная кастомная обработка статуса (возврат true отменяет стандартную обработку)
Параметры:
- $handled (bool) - Флаг обработки
- $payment_status (string) - Статус от Яндекс
- $order (WC_Order) - Объект заказа

4. `yandex_pay_status_change_note`
Изменяет заметку при смене статуса заказа
Параметры:
- $note (string) - Текст заметки
- $order (WC_Order) - Объект заказа
- $old_status (string) - Старый статус
- $new_status (string) - Новый статус

5. `yandex_pay_partial_refund_note`
Изменяет заметку для частичного возврата
Параметры:
- $note (string) - Текст заметки
- $order (WC_Order) - Объект заказа

= Улучшения безопасности =
* Усилена валидация входящих данных
* Улучшена обработка ошибок декодирования

= Исправлено =
* Проблемы с обработкой статуса PARTIALLY_REFUNDED

= 1.0.9 =
- В платежном шлюзе Яндекс Сплит реализована динамическая смена иконки в зависимости от выбранного способа оплаты
- При выборе "Сплит" отображается стандартная иконка Сплита
- При выборе "Карта + Сплит" отображается комбинированная иконка

= 1.0.8 =
= Улучшено распределение скидок =
- Все типы скидок (купоны, бонусы, отрицательные сборы) суммируются в общую сумму скидки
- Скидки распределяются пропорционально по товарам
- Остаток скидки добавляется к последнему товару для точного распределения
= Улучшено формирование корзины =
- Для товаров с количеством > 1 создаются отдельные позиции
- Скидка равномерно распределяется между единицами товара
- Скидки применяются только к товарам (не к доставке и сборам)

= 1.0.7 =
- Реализовано разделение стилей
- Мелки исправления
- Улучшена документация

= 1.0.6 =
**Основные изменения:**  
- Добавлены отдельные платежные шлюзы:  
  • `Яндекс Сплит` — оплата частями  
  • `Яндекс Пей` — классическая оплата картой  
- Реализовано разделение общей логики в базовый класс (`WC_Yandex_Base_Gateway`)  
- Улучшено хранение ссылок платежей:  
  • Платежные URL сохраняются в метаданные заказа  
  • Исключено повторное создание платежей для существующих заказов  

= 1.0.5 =
- Исправлена совместимость с WooCommerce 8.7
- Обновлены тестовые сценарии для PHP 8.3

= 1.0.4 =
- Добавлена поддержка мультиязычных сайтов
- Оптимизирована загрузка скриптов

= 1.0 =
- Первый релиз
- Базовая интеграция Yandex Pay/Сплит
- Поддержка классического редактора

== Лицензия ==
Этот плагин распространяется под лицензией GPLv2. Расширенные функции доступны в Pro-версии.